// Copyright (c) 2025  Egon Willighagen <egon.willighagen@gmail.com>
//
// GPL v3

@Grab(group='io.github.egonw.bacting', module='managers-ui', version='1.0.7')
@Grab(group='io.github.egonw.bacting', module='managers-rdf', version='1.0.7')

import java.io.*;
import java.util.*;

workspaceRoot = ".."
ui = new net.bioclipse.managers.UIManager(workspaceRoot);
bioclipse = new net.bioclipse.managers.BioclipseManager(workspaceRoot);
rdf = new net.bioclipse.managers.RDFManager(workspaceRoot);

TTL = ".ttl";

inFile = args[0];

ending = "ttl";
if (inFile.endsWith(TTL)) {
  suffix = TTL;
} else {
  println "Unsupported processing of ${inFile}"
  System.exit(-1);
}

outFile = "/code/" + inFile.replace(".ttl", ".md")

store = rdf.createInMemoryStore()
rdf.importFile(store, "/code/" + inFile, "TURTLE")

metadataQuery = """PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX dct: <http://purl.org/dc/terms/>
SELECT ?title ?description WHERE {
  ?guidance rdfs:label ?title ;
    dct:description ?description .
}"""

metadata = rdf.sparql(store, metadataQuery)

// println metadata

ui.append(outFile, "## " + metadata.get(1, "title") + "\n")
ui.append(outFile, "\n")
ui.append(outFile, "Description: " + metadata.get(1, "description") + "\n")
ui.append(outFile, "\n")

metadataQuery = """PREFIX cito: <http://purl.org/net/cito/>
SELECT ?citation WHERE {
  ?guidance cito:cites ?citation .
}"""

metadata = rdf.sparql(store, metadataQuery)

// println metadata

if (metadata.getRowCount() > 0) {
  ui.append(outFile, "Read more in [");
  for (citation in metadata.getColumn("citation")) {
    doi = citation.replace("https://doi.org/","").replace("http://doi.org/","")
    ui.append(outFile, "<cite>${doi}</cite>")
  }
  ui.append(outFile, "].\n");
}

